{% extends 'base.html' %}

{% block title %}GeulMeok9 - {{ novel.title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('index') }}">홈</a></li>
                    <li class="breadcrumb-item active">{{ novel.title }}</li>
                </ol>
            </nav>
            <h1>{{ novel.title }} <small class="text-muted">관리</small></h1>
        </div>
    </div>

    <div class="row">
        <!-- Left Column: Chapters -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">회차 목록</h5>
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#newChapterModal">
                        <i class="bi bi-plus-circle"></i> 새 회차
                    </button>
                </div>
                <div class="card-body">
                    {% if chapters %}
                        <ul class="chapter-list" id="chapterList">
                            {% for chapter in chapters %}
                                <li class="d-flex justify-content-between align-items-center" data-id="{{ chapter.id }}" data-order="{{ chapter.order }}">
                                    <span class="chapter-handle me-2"><i class="bi bi-grip-vertical"></i></span>
                                    <a href="{{ url_for('edit_chapter', novel_id=novel.id, chapter_id=chapter.id) }}" class="flex-grow-1">
                                        {{ chapter.title }}
                                    </a>
                                    <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteChapterModal-{{ chapter.id }}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                    
                                    <!-- Delete Chapter Modal -->
                                    <div class="modal fade" id="deleteChapterModal-{{ chapter.id }}" tabindex="-1" aria-labelledby="deleteChapterModalLabel-{{ chapter.id }}" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="deleteChapterModalLabel-{{ chapter.id }}">회차 삭제 확인</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <p class="text-danger">정말로 "{{ chapter.title }}" 회차를 삭제하시겠습니까?</p>
                                                    <p>이 작업은 되돌릴 수 없습니다.</p>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                                                    <form action="{{ url_for('delete_chapter', novel_id=novel.id, chapter_id=chapter.id) }}" method="POST">
                                                        <button type="submit" class="btn btn-danger">삭제</button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-center text-muted my-5">
                            <i class="bi bi-journal-text fs-1 d-block mb-3"></i>
                            아직 회차가 없습니다. '새 회차' 버튼을 클릭하여 추가하세요.
                        </p>
                    {% endif %}
                </div>
            </div>

            <!-- Major Summaries -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">대요약본</h5>
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#newMajorSummaryModal">
                        <i class="bi bi-plus-circle"></i> 새 대요약본
                    </button>
                </div>
                <div class="card-body">
                    {% if major_summaries %}
                        <div class="accordion" id="majorSummariesAccordion">
                            {% for summary in major_summaries %}
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="major-summary-heading-{{ summary.id }}">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#major-summary-collapse-{{ summary.id }}" aria-expanded="false" aria-controls="major-summary-collapse-{{ summary.id }}">
                                            {{ summary.title }}
                                        </button>
                                    </h2>
                                    <div id="major-summary-collapse-{{ summary.id }}" class="accordion-collapse collapse" aria-labelledby="major-summary-heading-{{ summary.id }}" data-bs-parent="#majorSummariesAccordion">
                                        <div class="accordion-body">
                                            <p>{{ summary.content|nl2br }}</p>
                                            <div class="d-flex">
                                                <button type="button" class="btn btn-sm btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#editMajorSummaryModal-{{ summary.id }}">
                                                    <i class="bi bi-pencil"></i> 수정
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteMajorSummaryModal-{{ summary.id }}">
                                                    <i class="bi bi-trash"></i> 삭제
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Edit Major Summary Modal -->
                                <div class="modal fade" id="editMajorSummaryModal-{{ summary.id }}" tabindex="-1" aria-labelledby="editMajorSummaryModalLabel-{{ summary.id }}" aria-hidden="true">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="editMajorSummaryModalLabel-{{ summary.id }}">대요약본 수정</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <form action="{{ url_for('edit_major_summary', novel_id=novel.id, major_summary_id=summary.id) }}" method="POST">
                                                <div class="modal-body">
                                                    <div class="mb-3">
                                                        <label for="editMajorSummaryTitle-{{ summary.id }}" class="form-label">제목</label>
                                                        <input type="text" class="form-control" id="editMajorSummaryTitle-{{ summary.id }}" name="title" value="{{ summary.title }}" required>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="editMajorSummaryContent-{{ summary.id }}" class="form-label">내용</label>
                                                        <textarea class="form-control" id="editMajorSummaryContent-{{ summary.id }}" name="content" rows="10" required>{{ summary.content }}</textarea>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                                                    <button type="submit" class="btn btn-primary">저장</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                <!-- Delete Major Summary Modal -->
                                <div class="modal fade" id="deleteMajorSummaryModal-{{ summary.id }}" tabindex="-1" aria-labelledby="deleteMajorSummaryModalLabel-{{ summary.id }}" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="deleteMajorSummaryModalLabel-{{ summary.id }}">대요약본 삭제 확인</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <p class="text-danger">정말로 "{{ summary.title }}" 대요약본을 삭제하시겠습니까?</p>
                                                <p>이 작업은 되돌릴 수 없습니다.</p>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                                                <form action="{{ url_for('delete_major_summary', novel_id=novel.id, major_summary_id=summary.id) }}" method="POST">
                                                    <button type="submit" class="btn btn-danger">삭제</button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-center text-muted my-3">
                            대요약본이 없습니다. '새 대요약본' 버튼을 클릭하여 추가하세요.
                        </p>
                    {% endif %}
                </div>
            </div>

            <!-- Characters -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">캐릭터</h5>
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#newCharacterModal">
                        <i class="bi bi-plus-circle"></i> 새 캐릭터
                    </button>
                </div>
                <div class="card-body">
                    {% if characters %}
                        <div class="accordion" id="charactersAccordion">
                            {% for character in characters %}
                                <div class="accordion-item" data-id="{{ character.id }}" data-order="{{ character.order }}">
                                    <h2 class="accordion-header" id="character-heading-{{ character.id }}">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#character-collapse-{{ character.id }}" aria-expanded="false" aria-controls="character-collapse-{{ character.id }}">
                                            <i class="bi bi-grip-vertical character-handle me-2"></i>
                                            {{ character.name }}
                                        </button>
                                    </h2>
                                    <div id="character-collapse-{{ character.id }}" class="accordion-collapse collapse" aria-labelledby="character-heading-{{ character.id }}" data-bs-parent="#charactersAccordion">
                                        <div class="accordion-body">
                                            <p>{{ character.description|nl2br }}</p>
                                            <div class="d-flex">
                                                <button type="button" class="btn btn-sm btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#editCharacterModal-{{ character.id }}">
                                                    <i class="bi bi-pencil"></i> 수정
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteCharacterModal-{{ character.id }}">
                                                    <i class="bi bi-trash"></i> 삭제
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Edit Character Modal -->
                                <div class="modal fade" id="editCharacterModal-{{ character.id }}" tabindex="-1" aria-labelledby="editCharacterModalLabel-{{ character.id }}" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="editCharacterModalLabel-{{ character.id }}">캐릭터 수정</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <form method="POST" action="{{ url_for('edit_character', novel_id=novel.id, character_id=character.id) }}">
                                                <div class="modal-body">
                                                    <div class="mb-3">
                                                        <label for="character-name-{{ character.id }}" class="form-label">이름</label>
                                                        <input type="text" class="form-control" id="character-name-{{ character.id }}" name="name" value="{{ character.name }}" required>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="character-description-{{ character.id }}" class="form-label">설명</label>
                                                        <textarea class="form-control" id="character-description-{{ character.id }}" name="description" rows="5">{{ character.description }}</textarea>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                                                    <button type="submit" class="btn btn-primary">저장</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Delete Character Modal -->
                                <div class="modal fade" id="deleteCharacterModal-{{ character.id }}" tabindex="-1" aria-labelledby="deleteCharacterModalLabel-{{ character.id }}" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="deleteCharacterModalLabel-{{ character.id }}">캐릭터 삭제 확인</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <p class="text-danger">정말로 "{{ character.name }}" 캐릭터를 삭제하시겠습니까?</p>
                                                <p>이 작업은 되돌릴 수 없습니다.</p>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                                                <form action="{{ url_for('delete_character', novel_id=novel.id, character_id=character.id) }}" method="POST">
                                                    <button type="submit" class="btn btn-danger">삭제</button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-center text-muted my-3">
                            캐릭터가 없습니다. '새 캐릭터' 버튼을 클릭하여 추가하세요.
                        </p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Middle Column: Settings -->
        <div class="col-md-4">
            <!-- Settings -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">설정집</h5>
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#newSettingModal">
                        <i class="bi bi-plus-circle"></i> 새 설정
                    </button>
                </div>
                <div class="card-body">
                    {% if settings %}
                        <div class="accordion" id="settingsAccordion">
                            {% for setting in settings %}
                                <div class="accordion-item" data-id="{{ setting.id }}" data-order="{{ setting.order }}">
                                    <h2 class="accordion-header" id="setting-heading-{{ setting.id }}">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#setting-collapse-{{ setting.id }}" aria-expanded="false" aria-controls="setting-collapse-{{ setting.id }}">
                                            <i class="bi bi-grip-vertical setting-handle me-2"></i>
                                            {{ setting.title }}
                                        </button>
                                    </h2>
                                    <div id="setting-collapse-{{ setting.id }}" class="accordion-collapse collapse" aria-labelledby="setting-heading-{{ setting.id }}" data-bs-parent="#settingsAccordion">
                                        <div class="accordion-body">
                                            <p>{{ setting.content|nl2br }}</p>
                                            <div class="d-flex">
                                                <button type="button" class="btn btn-sm btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#editSettingModal-{{ setting.id }}">
                                                    <i class="bi bi-pencil"></i> 수정
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteSettingModal-{{ setting.id }}">
                                                    <i class="bi bi-trash"></i> 삭제
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Edit Setting Modal -->
                                <div class="modal fade" id="editSettingModal-{{ setting.id }}" tabindex="-1" aria-labelledby="editSettingModalLabel-{{ setting.id }}" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="editSettingModalLabel-{{ setting.id }}">설정 수정</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <form method="POST" action="{{ url_for('edit_setting', novel_id=novel.id, setting_id=setting.id) }}">
                                                <div class="modal-body">
                                                    <div class="mb-3">
                                                        <label for="setting-title-{{ setting.id }}" class="form-label">제목</label>
                                                        <input type="text" class="form-control" id="setting-title-{{ setting.id }}" name="title" value="{{ setting.title }}" required>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="setting-content-{{ setting.id }}" class="form-label">내용</label>
                                                        <textarea class="form-control" id="setting-content-{{ setting.id }}" name="content" rows="5">{{ setting.content }}</textarea>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                                                    <button type="submit" class="btn btn-primary">저장</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Delete Setting Modal -->
                                <div class="modal fade" id="deleteSettingModal-{{ setting.id }}" tabindex="-1" aria-labelledby="deleteSettingModalLabel-{{ setting.id }}" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="deleteSettingModalLabel-{{ setting.id }}">설정 삭제 확인</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <p class="text-danger">정말로 "{{ setting.title }}" 설정을 삭제하시겠습니까?</p>
                                                <p>이 작업은 되돌릴 수 없습니다.</p>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                                                <form action="{{ url_for('delete_setting', novel_id=novel.id, setting_id=setting.id) }}" method="POST">
                                                    <button type="submit" class="btn btn-danger">삭제</button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-center text-muted my-3">
                            설정이 없습니다. '새 설정' 버튼을 클릭하여 추가하세요.
                        </p>
                    {% endif %}
                </div>
            </div>

            <!-- Prompts -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">프롬프트</h5>
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#newPromptModal">
                        <i class="bi bi-plus-circle"></i> 새 프롬프트
                    </button>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs" id="promptTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="system-tab" data-bs-toggle="tab" data-bs-target="#system-prompts" type="button" role="tab" aria-controls="system-prompts" aria-selected="true">시스템</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="top-tab" data-bs-toggle="tab" data-bs-target="#top-prompts" type="button" role="tab" aria-controls="top-prompts" aria-selected="false">상단</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="bottom-tab" data-bs-toggle="tab" data-bs-target="#bottom-prompts" type="button" role="tab" aria-controls="bottom-prompts" aria-selected="false">하단</button>
                        </li>
                    </ul>
                    <div class="tab-content p-3" id="promptTabContent">
                        <div class="tab-pane fade show active" id="system-prompts" role="tabpanel" aria-labelledby="system-tab">
                            {% if system_prompts %}
                                <div class="list-group">
                                    {% for prompt in system_prompts %}
                                        <div class="list-group-item">
                                            <div class="d-flex w-100 justify-content-between">
                                                <h6 class="mb-1">{{ prompt.name }}</h6>
                                                <div>
                                                    <button type="button" class="btn btn-sm btn-outline-primary me-1" data-bs-toggle="modal" data-bs-target="#editPromptModal-{{ prompt.id }}">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deletePromptModal-{{ prompt.id }}">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <p class="mb-1 small text-truncate">{{ prompt.content }}</p>
                                        </div>
                                        
                                        <!-- Delete Prompt Modal -->
                                        <div class="modal fade" id="deletePromptModal-{{ prompt.id }}" tabindex="-1" aria-labelledby="deletePromptModalLabel-{{ prompt.id }}" aria-hidden="true">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="deletePromptModalLabel-{{ prompt.id }}">프롬프트 삭제 확인</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <p class="text-danger">정말로 "{{ prompt.name }}" 프롬프트를 삭제하시겠습니까?</p>
                                                        <p>이 작업은 되돌릴 수 없습니다.</p>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                                                        <form action="{{ url_for('delete_prompt', novel_id=novel.id, prompt_id=prompt.id) }}" method="POST">
                                                            <button type="submit" class="btn btn-danger">삭제</button>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Edit Prompt Modal -->
                                        <div class="modal fade" id="editPromptModal-{{ prompt.id }}" tabindex="-1" aria-labelledby="editPromptModalLabel-{{ prompt.id }}" aria-hidden="true">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="editPromptModalLabel-{{ prompt.id }}">프롬프트 수정</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <form method="POST" action="{{ url_for('edit_prompt', novel_id=novel.id, prompt_id=prompt.id) }}">
                                                        <div class="modal-body">
                                                            <div class="mb-3">
                                                                <label for="editPromptName-{{ prompt.id }}" class="form-label">프롬프트 이름</label>
                                                                <input type="text" class="form-control" id="editPromptName-{{ prompt.id }}" name="name" value="{{ prompt.name }}" required>
                                                            </div>
                                                            <div class="mb-3">
                                                                <label for="editPromptType-{{ prompt.id }}" class="form-label">프롬프트 유형</label>
                                                                <select class="form-select" id="editPromptType-{{ prompt.id }}" name="prompt_type" required>
                                                                    <option value="system" {% if prompt.prompt_type == 'system' %}selected{% endif %}>시스템 프롬프트</option>
                                                                    <option value="top" {% if prompt.prompt_type == 'top' %}selected{% endif %}>상단 프롬프트</option>
                                                                    <option value="bottom" {% if prompt.prompt_type == 'bottom' %}selected{% endif %}>하단 프롬프트</option>
                                                                </select>
                                                            </div>
                                                            <div class="mb-3">
                                                                <label for="editPromptContent-{{ prompt.id }}" class="form-label">프롬프트 내용</label>
                                                                <textarea class="form-control" id="editPromptContent-{{ prompt.id }}" name="content" rows="5">{{ prompt.content }}</textarea>
                                                            </div>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                                                            <button type="submit" class="btn btn-primary">저장</button>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-center text-muted my-3">
                                    시스템 프롬프트가 없습니다.
                                </p>
                            {% endif %}
                        </div>
                        <div class="tab-pane fade" id="top-prompts" role="tabpanel" aria-labelledby="top-tab">
                            {% if top_prompts %}
                                <div class="list-group">
                                    {% for prompt in top_prompts %}
                                        <div class="list-group-item">
                                            <div class="d-flex w-100 justify-content-between">
                                                <h6 class="mb-1">{{ prompt.name }}</h6>
                                                <div>
                                                    <button type="button" class="btn btn-sm btn-outline-primary me-1" data-bs-toggle="modal" data-bs-target="#editPromptModal-{{ prompt.id }}">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deletePromptModal-{{ prompt.id }}">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <p class="mb-1 small text-truncate">{{ prompt.content }}</p>
                                        </div>
                                        
                                        <!-- Delete Prompt Modal -->
                                        <div class="modal fade" id="deletePromptModal-{{ prompt.id }}" tabindex="-1" aria-labelledby="deletePromptModalLabel-{{ prompt.id }}" aria-hidden="true">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="deletePromptModalLabel-{{ prompt.id }}">프롬프트 삭제 확인</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <p class="text-danger">정말로 "{{ prompt.name }}" 프롬프트를 삭제하시겠습니까?</p>
                                                        <p>이 작업은 되돌릴 수 없습니다.</p>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                                                        <form action="{{ url_for('delete_prompt', novel_id=novel.id, prompt_id=prompt.id) }}" method="POST">
                                                            <button type="submit" class="btn btn-danger">삭제</button>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Edit Prompt Modal -->
                                        <div class="modal fade" id="editPromptModal-{{ prompt.id }}" tabindex="-1" aria-labelledby="editPromptModalLabel-{{ prompt.id }}" aria-hidden="true">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="editPromptModalLabel-{{ prompt.id }}">프롬프트 수정</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <form method="POST" action="{{ url_for('edit_prompt', novel_id=novel.id, prompt_id=prompt.id) }}">
                                                        <div class="modal-body">
                                                            <div class="mb-3">
                                                                <label for="editPromptName-{{ prompt.id }}" class="form-label">프롬프트 이름</label>
                                                                <input type="text" class="form-control" id="editPromptName-{{ prompt.id }}" name="name" value="{{ prompt.name }}" required>
                                                            </div>
                                                            <div class="mb-3">
                                                                <label for="editPromptType-{{ prompt.id }}" class="form-label">프롬프트 유형</label>
                                                                <select class="form-select" id="editPromptType-{{ prompt.id }}" name="prompt_type" required>
                                                                    <option value="system" {% if prompt.prompt_type == 'system' %}selected{% endif %}>시스템 프롬프트</option>
                                                                    <option value="top" {% if prompt.prompt_type == 'top' %}selected{% endif %}>상단 프롬프트</option>
                                                                    <option value="bottom" {% if prompt.prompt_type == 'bottom' %}selected{% endif %}>하단 프롬프트</option>
                                                                </select>
                                                            </div>
                                                            <div class="mb-3">
                                                                <label for="editPromptContent-{{ prompt.id }}" class="form-label">프롬프트 내용</label>
                                                                <textarea class="form-control" id="editPromptContent-{{ prompt.id }}" name="content" rows="5">{{ prompt.content }}</textarea>
                                                            </div>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                                                            <button type="submit" class="btn btn-primary">저장</button>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-center text-muted my-3">
                                    상단 프롬프트가 없습니다.
                                </p>
                            {% endif %}
                        </div>
                        <div class="tab-pane fade" id="bottom-prompts" role="tabpanel" aria-labelledby="bottom-tab">
                            {% if bottom_prompts %}
                                <div class="list-group">
                                    {% for prompt in bottom_prompts %}
                                        <div class="list-group-item">
                                            <div class="d-flex w-100 justify-content-between">
                                                <h6 class="mb-1">{{ prompt.name }}</h6>
                                                <div>
                                                    <button type="button" class="btn btn-sm btn-outline-primary me-1" data-bs-toggle="modal" data-bs-target="#editPromptModal-{{ prompt.id }}">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deletePromptModal-{{ prompt.id }}">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <p class="mb-1 small text-truncate">{{ prompt.content }}</p>
                                        </div>
                                        
                                        <!-- Delete Prompt Modal -->
                                        <div class="modal fade" id="deletePromptModal-{{ prompt.id }}" tabindex="-1" aria-labelledby="deletePromptModalLabel-{{ prompt.id }}" aria-hidden="true">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="deletePromptModalLabel-{{ prompt.id }}">프롬프트 삭제 확인</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <p class="text-danger">정말로 "{{ prompt.name }}" 프롬프트를 삭제하시겠습니까?</p>
                                                        <p>이 작업은 되돌릴 수 없습니다.</p>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                                                        <form action="{{ url_for('delete_prompt', novel_id=novel.id, prompt_id=prompt.id) }}" method="POST">
                                                            <button type="submit" class="btn btn-danger">삭제</button>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Edit Prompt Modal -->
                                        <div class="modal fade" id="editPromptModal-{{ prompt.id }}" tabindex="-1" aria-labelledby="editPromptModalLabel-{{ prompt.id }}" aria-hidden="true">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="editPromptModalLabel-{{ prompt.id }}">프롬프트 수정</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <form method="POST" action="{{ url_for('edit_prompt', novel_id=novel.id, prompt_id=prompt.id) }}">
                                                        <div class="modal-body">
                                                            <div class="mb-3">
                                                                <label for="editPromptName-{{ prompt.id }}" class="form-label">프롬프트 이름</label>
                                                                <input type="text" class="form-control" id="editPromptName-{{ prompt.id }}" name="name" value="{{ prompt.name }}" required>
                                                            </div>
                                                            <div class="mb-3">
                                                                <label for="editPromptType-{{ prompt.id }}" class="form-label">프롬프트 유형</label>
                                                                <select class="form-select" id="editPromptType-{{ prompt.id }}" name="prompt_type" required>
                                                                    <option value="system" {% if prompt.prompt_type == 'system' %}selected{% endif %}>시스템 프롬프트</option>
                                                                    <option value="top" {% if prompt.prompt_type == 'top' %}selected{% endif %}>상단 프롬프트</option>
                                                                    <option value="bottom" {% if prompt.prompt_type == 'bottom' %}selected{% endif %}>하단 프롬프트</option>
                                                                </select>
                                                            </div>
                                                            <div class="mb-3">
                                                                <label for="editPromptContent-{{ prompt.id }}" class="form-label">프롬프트 내용</label>
                                                                <textarea class="form-control" id="editPromptContent-{{ prompt.id }}" name="content" rows="5">{{ prompt.content }}</textarea>
                                                            </div>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                                                            <button type="submit" class="btn btn-primary">저장</button>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-center text-muted my-3">
                                    하단 프롬프트가 없습니다.
                                </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: AI Assistant -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">AI 보조 기능</h5>
                </div>
                <div class="card-body">
                    <form action="{{ url_for('ai_assist', novel_id=novel.id) }}" method="POST" id="aiAssistForm">
                        <div class="mb-3">
                            <label for="mainModel" class="form-label">메인 모델</label>
                            <select class="form-select" id="mainModel" name="main_model">
                                {% for model in models.main %}
                                    <option value="{{ model }}">{{ model }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="assistantModel" class="form-label">보조 모델</label>
                            <select class="form-select" id="assistantModel" name="assistant_model">
                                {% for model in models.assistant %}
                                    <option value="{{ model }}">{{ model }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">시스템 프롬프트</label>
                            <select class="form-select" name="system_prompt" id="systemPrompt">
                                <option value="">선택 안함</option>
                                {% for prompt in system_prompts %}
                                    <option value="{{ prompt.id }}" {% if selected_system_prompt == prompt.id|string %}selected{% endif %}>{{ prompt.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">상단 프롬프트</label>
                            <select class="form-select" name="top_prompt" id="topPrompt">
                                <option value="">선택 안함</option>
                                {% for prompt in top_prompts %}
                                    <option value="{{ prompt.id }}" {% if selected_top_prompt == prompt.id|string %}selected{% endif %}>{{ prompt.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">하단 프롬프트</label>
                            <select class="form-select" name="bottom_prompt" id="bottomPrompt">
                                <option value="">선택 안함</option>
                                {% for prompt in bottom_prompts %}
                                    <option value="{{ prompt.id }}" {% if selected_bottom_prompt == prompt.id|string %}selected{% endif %}>{{ prompt.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">대요약본 선택</label>
                            <div class="form-text mb-2">AI에게 전달할 대요약본을 선택하세요. 여러 회차의 종합적인 요약을 제공합니다.</div>
                            {% if major_summaries %}
                                <div class="list-group" style="max-height: 200px; overflow-y: auto;">
                                    {% for summary in major_summaries %}
                                        <label class="list-group-item">
                                            <input class="form-check-input me-1" type="checkbox" name="major_summaries" value="{{ summary.id }}">
                                            {{ summary.title }}
                                        </label>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="alert alert-warning">
                                    대요약본이 없습니다. '대요약본' 섹션에서 추가해주세요.
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">요약본 선택</label>
                            <div class="form-text mb-2">AI에게 전달할 회차 요약본을 선택하세요.</div>
                            {% if chapters %}
                                <div class="list-group" style="max-height: 200px; overflow-y: auto;">
                                    {% for chapter in chapters %}
                                        <label class="list-group-item">
                                            <input class="form-check-input me-1" type="checkbox" name="summary_chapters" value="{{ chapter.id }}">
                                            {{ chapter.title }} (요약)
                                        </label>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="alert alert-warning">
                                    회차가 없습니다. 먼저 회차를 추가해주세요.
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">회차 선택</label>
                            <div class="form-text mb-2">AI에게 전달할 회차 본문을 선택하세요.</div>
                            {% if chapters %}
                                <div class="list-group" style="max-height: 200px; overflow-y: auto;">
                                    {% for chapter in chapters %}
                                        <label class="list-group-item">
                                            <input class="form-check-input me-1" type="checkbox" name="content_chapters" value="{{ chapter.id }}">
                                            {{ chapter.title }} (본문)
                                        </label>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="alert alert-warning">
                                    회차가 없습니다. 먼저 회차를 추가해주세요.
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="userInput" class="form-label">메인 프롬프트 (질문 또는 콘티)</label>
                            <div class="mb-2">
                                <div class="btn-group w-100" role="group" aria-label="프롬프트 유형">
                                    <input type="radio" class="btn-check" name="prompt_type" id="promptType1" value="no_content" autocomplete="off">
                                    <label class="btn btn-outline-primary" for="promptType1">콘티 없이 회차 작성</label>
                                    
                                    <input type="radio" class="btn-check" name="prompt_type" id="promptType2" value="with_content" autocomplete="off" checked>
                                    <label class="btn btn-outline-primary" for="promptType2">콘티에 따라 회차 작성</label>
                                    
                                    <input type="radio" class="btn-check" name="prompt_type" id="promptType3" value="question" autocomplete="off">
                                    <label class="btn btn-outline-primary" for="promptType3">질문 및 기타 프롬프트</label>
                                </div>
                            </div>
                            <textarea class="form-control" id="userInput" name="user_input" rows="5" placeholder="AI에게 질문하거나 다음 회차의 콘티를 입력하세요."></textarea>
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100" id="generateButton">AI 응답 생성</button>
                    </form>
                    
                    <!-- Loading Overlay -->
                    <div id="loadingOverlay" class="position-absolute top-0 start-0 w-100 h-100 bg-white bg-opacity-75 d-flex flex-column justify-content-center align-items-center" style="display: none !important; z-index: 1000;">
                        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <h5 class="text-primary">AI 응답 생성 중...</h5>
                        <p class="text-muted small">잠시만 기다려주세요.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <!-- New Chapter Modal -->
    <div class="modal fade" id="newChapterModal" tabindex="-1" aria-labelledby="newChapterModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="newChapterModalLabel">새 회차 추가</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('new_chapter', novel_id=novel.id) }}">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="chapterTitle" class="form-label">회차 제목</label>
                            <input type="text" class="form-control" id="chapterTitle" name="title" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                        <button type="submit" class="btn btn-primary">추가</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- New Character Modal -->
    <div class="modal fade" id="newCharacterModal" tabindex="-1" aria-labelledby="newCharacterModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="newCharacterModalLabel">새 캐릭터 추가</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('new_character', novel_id=novel.id) }}">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="characterName" class="form-label">캐릭터 이름</label>
                            <input type="text" class="form-control" id="characterName" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="characterDescription" class="form-label">캐릭터 설명</label>
                            <textarea class="form-control" id="characterDescription" name="description" rows="5"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                        <button type="submit" class="btn btn-primary">추가</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- New Setting Modal -->
    <div class="modal fade" id="newSettingModal" tabindex="-1" aria-labelledby="newSettingModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="newSettingModalLabel">새 설정 추가</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('new_setting', novel_id=novel.id) }}">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="settingTitle" class="form-label">설정 제목</label>
                            <input type="text" class="form-control" id="settingTitle" name="title" required>
                        </div>
                        <div class="mb-3">
                            <label for="settingContent" class="form-label">설정 내용</label>
                            <textarea class="form-control" id="settingContent" name="content" rows="5"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                        <button type="submit" class="btn btn-primary">추가</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- New Prompt Modal -->
    <div class="modal fade" id="newPromptModal" tabindex="-1" aria-labelledby="newPromptModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="newPromptModalLabel">새 프롬프트 추가</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('new_prompt', novel_id=novel.id) }}">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="promptName" class="form-label">프롬프트 이름</label>
                            <input type="text" class="form-control" id="promptName" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="promptType" class="form-label">프롬프트 유형</label>
                            <select class="form-select" id="promptType" name="prompt_type" required>
                                <option value="system">시스템 프롬프트</option>
                                <option value="top">상단 프롬프트</option>
                                <option value="bottom">하단 프롬프트</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="promptContent" class="form-label">프롬프트 내용</label>
                            <textarea class="form-control" id="promptContent" name="content" rows="5"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                        <button type="submit" class="btn btn-primary">추가</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- New Major Summary Modal -->
    <div class="modal fade" id="newMajorSummaryModal" tabindex="-1" aria-labelledby="newMajorSummaryModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="newMajorSummaryModalLabel">새 대요약본 추가</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" id="majorSummaryTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual-content" type="button" role="tab" aria-controls="manual-content" aria-selected="true">직접 작성</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="generate-tab" data-bs-toggle="tab" data-bs-target="#generate-content" type="button" role="tab" aria-controls="generate-content" aria-selected="false">AI 생성</button>
                        </li>
                    </ul>
                    <div class="tab-content p-3" id="majorSummaryTabContent">
                        <!-- 직접 작성 탭 -->
                        <div class="tab-pane fade show active" id="manual-content" role="tabpanel" aria-labelledby="manual-tab">
                            <form method="POST" action="{{ url_for('new_major_summary', novel_id=novel.id) }}">
                                <div class="mb-3">
                                    <label for="majorSummaryTitle" class="form-label">대요약본 제목</label>
                                    <input type="text" class="form-control" id="majorSummaryTitle" name="title" required>
                                </div>
                                <div class="mb-3">
                                    <label for="majorSummaryContent" class="form-label">대요약본 내용</label>
                                    <textarea class="form-control" id="majorSummaryContent" name="content" rows="10" required></textarea>
                                </div>
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary">추가</button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- AI 생성 탭 -->
                        <div class="tab-pane fade" id="generate-content" role="tabpanel" aria-labelledby="generate-tab">
                            <form method="POST" action="{{ url_for('generate_major_summary_route', novel_id=novel.id) }}" id="generateMajorSummaryForm">
                                <div class="mb-3">
                                    <label class="form-label">요약할 회차 선택</label>
                                    <div class="form-text mb-2">대요약본에 포함할 회차를 선택하세요.</div>
                                    {% if chapters %}
                                        <div class="list-group" style="max-height: 200px; overflow-y: auto;">
                                            {% for chapter in chapters %}
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="chapter_ids" value="{{ chapter.id }}" id="chapter-select-{{ chapter.id }}">
                                                    <label class="form-check-label" for="chapter-select-{{ chapter.id }}">
                                                        {{ chapter.title }}
                                                    </label>
                                                </div>
                                            {% endfor %}
                                        </div>
                                        <div class="d-flex justify-content-end mt-2">
                                            <button type="button" class="btn btn-sm btn-outline-secondary me-2" id="selectAllChapters">모두 선택</button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" id="deselectAllChapters">모두 해제</button>
                                        </div>
                                    {% else %}
                                        <p class="text-muted">회차가 없습니다. 먼저 회차를 추가하세요.</p>
                                    {% endif %}
                                </div>
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary" id="generateMajorSummaryBtn">대요약본 생성</button>
                                </div>
                                
                                <!-- 로딩 오버레이 -->
                                <div id="summaryLoadingOverlay" class="position-absolute top-0 start-0 w-100 h-100 bg-white bg-opacity-75 d-flex flex-column justify-content-center align-items-center" style="display: none !important; z-index: 1000;">
                                    <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                                        <span class="visually-hidden">로딩 중...</span>
                                    </div>
                                    <p class="text-primary fw-bold">대요약본 생성 중...</p>
                                    <p class="text-muted small">AI가 선택한 회차들을 분석하고 있습니다. 이 작업은 최대 1분 정도 소요될 수 있습니다.</p>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 회차 정렬 기능
        const chapterList = document.getElementById('chapterList');
        if (chapterList) {
            new Sortable(chapterList, {
                handle: '.chapter-handle',
                animation: 150,
                onEnd: function(evt) {
                    const chapters = Array.from(chapterList.querySelectorAll('li'));
                    const chapterOrders = chapters.map((chapter, index) => {
                        return {
                            id: chapter.dataset.id,
                            order: index
                        };
                    });
                    
                    fetch(`/novel/{{ novel.id }}/chapters/reorder`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ chapters: chapterOrders })
                    });
                }
            });
        }
        
        // 캐릭터 정렬 기능
        const charactersAccordion = document.getElementById('charactersAccordion');
        if (charactersAccordion) {
            new Sortable(charactersAccordion, {
                handle: '.character-handle',
                animation: 150,
                onEnd: function(evt) {
                    const characters = Array.from(charactersAccordion.querySelectorAll('.accordion-item'));
                    const characterOrders = characters.map((character, index) => {
                        return {
                            id: character.dataset.id,
                            order: index
                        };
                    });
                    
                    fetch(`/novel/{{ novel.id }}/characters/reorder`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ characters: characterOrders })
                    });
                }
            });
        }
        
        // 설정집 정렬 기능
        const settingsAccordion = document.getElementById('settingsAccordion');
        if (settingsAccordion) {
            new Sortable(settingsAccordion, {
                handle: '.setting-handle',
                animation: 150,
                onEnd: function(evt) {
                    const settings = Array.from(settingsAccordion.querySelectorAll('.accordion-item'));
                    const settingOrders = settings.map((setting, index) => {
                        return {
                            id: setting.dataset.id,
                            order: index
                        };
                    });
                    
                    fetch(`/novel/{{ novel.id }}/settings/reorder`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ settings: settingOrders })
                    });
                }
            });
        }
        
        // 프롬프트 유형 변경 시 텍스트 영역 활성화/비활성화
        const promptTypeRadios = document.querySelectorAll('input[name="prompt_type"]');
        const userInputTextarea = document.getElementById('userInput');
        
        if (promptTypeRadios.length > 0 && userInputTextarea) {
            // 초기 상태 설정
            setUserInputState();
            
            // 라디오 버튼 변경 이벤트 리스너
            promptTypeRadios.forEach(radio => {
                radio.addEventListener('change', setUserInputState);
            });
            
            // 텍스트 영역 상태 설정 함수
            function setUserInputState() {
                const selectedType = document.querySelector('input[name="prompt_type"]:checked').value;
                
                if (selectedType === 'no_content') {
                    userInputTextarea.disabled = true;
                    userInputTextarea.placeholder = '콘티 없이 회차 작성을 선택하셨습니다. AI가 자동으로 회차를 작성합니다.';
                    userInputTextarea.value = '';
                } else if (selectedType === 'with_content') {
                    userInputTextarea.disabled = false;
                    userInputTextarea.placeholder = '다음 회차의 콘티를 입력하세요.';
                } else if (selectedType === 'question') {
                    userInputTextarea.disabled = false;
                    userInputTextarea.placeholder = 'AI에게 질문하거나 기타 프롬프트를 입력하세요.';
                }
            }
        }
        
        // AI Assist form loading overlay
        const aiAssistForm = document.getElementById('aiAssistForm');
        const loadingOverlay = document.getElementById('loadingOverlay');
        
        if (aiAssistForm && loadingOverlay) {
            aiAssistForm.addEventListener('submit', function() {
                loadingOverlay.style.display = 'flex';
            });
        }
        
        // 대요약본 생성 관련 기능
        const generateMajorSummaryForm = document.getElementById('generateMajorSummaryForm');
        const summaryLoadingOverlay = document.getElementById('summaryLoadingOverlay');
        const selectAllChapters = document.getElementById('selectAllChapters');
        const deselectAllChapters = document.getElementById('deselectAllChapters');
        
        // 모두 선택 버튼
        if (selectAllChapters) {
            selectAllChapters.addEventListener('click', function() {
                const checkboxes = document.querySelectorAll('input[name="chapter_ids"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = true;
                });
            });
        }
        
        // 모두 해제 버튼
        if (deselectAllChapters) {
            deselectAllChapters.addEventListener('click', function() {
                const checkboxes = document.querySelectorAll('input[name="chapter_ids"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
            });
        }
        
        // 대요약본 생성 로딩 오버레이
        if (generateMajorSummaryForm && summaryLoadingOverlay) {
            generateMajorSummaryForm.addEventListener('submit', function(e) {
                // 최소 하나의 회차가 선택되었는지 확인
                const checkboxes = document.querySelectorAll('input[name="chapter_ids"]:checked');
                if (checkboxes.length === 0) {
                    e.preventDefault();
                    alert('최소 하나 이상의 회차를 선택해주세요.');
                    return false;
                }
                
                // 로딩 오버레이 표시
                summaryLoadingOverlay.style.display = 'flex';
            });
        }
    });
</script>
{% endblock %}
