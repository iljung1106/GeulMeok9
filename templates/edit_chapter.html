{% extends 'base.html' %}

{% block title %}GeulMeok9 - {{ chapter.title }} 편집{% endblock %}

{% block extra_head %}
<style>
    .editor-toolbar {
        padding: 10px;
        background-color: #f8f9fa;
        border: 1px solid #ced4da;
        border-bottom: none;
        border-radius: 4px 4px 0 0;
    }
    .editor-container {
        height: calc(100vh - 250px);
    }
    .editor {
        height: 100%;
        border: 1px solid #ced4da;
        border-radius: 0 0 4px 4px;
        padding: 15px;
        background-color: white;
        overflow-y: auto;
        font-family: 'Nanum Gothic', sans-serif;
        font-size: 16px;
        line-height: 1.8;
    }
    .word-count {
        font-size: 0.9rem;
        color: #6c757d;
    }
    .chapter-info {
        font-size: 0.9rem;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('index') }}">홈</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('edit_novel', novel_id=novel.id) }}">{{ novel.title }}</a></li>
                    <li class="breadcrumb-item active">{{ chapter.title }}</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <div class="col-md-9">
            <form id="chapterForm" method="POST" action="{{ url_for('save_chapter', novel_id=novel.id, chapter_id=chapter.id) }}">
                <div class="mb-3">
                    <input type="text" class="form-control form-control-lg" id="chapterTitle" name="title" value="{{ chapter.title }}" placeholder="회차 제목">
                </div>
                
                <div class="editor-toolbar d-flex justify-content-between align-items-center">
                    <div>
                        <button type="button" class="btn btn-sm btn-outline-secondary me-1" id="boldBtn" title="굵게">
                            <i class="bi bi-type-bold"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary me-1" id="italicBtn" title="기울임">
                            <i class="bi bi-type-italic"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary me-3" id="underlineBtn" title="밑줄">
                            <i class="bi bi-type-underline"></i>
                        </button>
                        
                        <button type="button" class="btn btn-sm btn-outline-secondary me-1" id="checkSpellingBtn" title="맞춤법 검사">
                            <i class="bi bi-spellcheck"></i> 맞춤법 검사
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary me-1" id="reviewChapterBtn" title="회차 감평">
                            <i class="bi bi-chat-quote"></i> 회차 감평
                        </button>
                        <div class="dropdown d-inline-block me-1">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="styleTransformBtn" data-bs-toggle="dropdown" aria-expanded="false" title="문체 변환">
                                <i class="bi bi-pencil-square"></i> 문체 변환
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="styleTransformBtn">
                                <li><a class="dropdown-item" href="#" id="elaborateStyleBtn">구체적으로 변환</a></li>
                                <li><a class="dropdown-item" href="#" id="conciseStyleBtn">간략하게 변환</a></li>
                            </ul>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-secondary me-1" id="modifyWithInstructionsBtn" title="지시에 따라 수정">
                            <i class="bi bi-magic"></i> 지시에 따라 수정
                        </button>
                    </div>
                    <div class="word-count">
                        <span id="characterCount">0</span>자 / <span id="wordCount">0</span>단어
                    </div>
                </div>
                
                <div class="editor-container mb-3">
                    <div class="editor" id="editor" contenteditable="true">{{ chapter.content|safe }}</div>
                    <textarea name="content" id="hiddenContent" style="display: none;">{{ chapter.content }}</textarea>
                </div>
                
                <div class="d-flex justify-content-between mb-4">
                    <div class="chapter-info">
                        {% if chapter.updated_at %}
                            마지막 수정: {{ chapter.updated_at.strftime('%Y-%m-%d %H:%M') }}
                        {% endif %}
                    </div>
                    <div>
                        <input type="hidden" name="assistant_model" id="assistantModel" value="{{ models.assistant[0] }}">
                        <button type="button" class="btn btn-outline-secondary me-2" id="regenerateSummaryBtn">
                            <i class="bi bi-arrow-repeat"></i> 요약 다시 생성
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> 저장
                        </button>
                    </div>
                </div>
            </form>
        </div>
        
        <div class="col-md-3">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">회차 요약</h5>
                </div>
                <div class="card-body">
                    {% if chapter.summary %}
                        <p>{{ chapter.summary }}</p>
                    {% else %}
                        <p class="text-muted">회차 내용을 저장하면 자동으로 요약이 생성됩니다.</p>
                    {% endif %}
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">보조 모델 설정</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="assistantModelSelect" class="form-label">맞춤법 검사 및 요약 모델</label>
                        <select class="form-select" id="assistantModelSelect">
                            {% for model in models.assistant %}
                                <option value="{{ model }}">{{ model }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">맞춤법 검사와 회차 요약에 사용할 모델을 선택하세요.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Spelling Check Result Modal -->
<div class="modal fade" id="spellingResultModal" tabindex="-1" aria-labelledby="spellingResultModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="spellingResultModalLabel">맞춤법 검사 결과</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="spellingResult">
                    <div class="d-flex justify-content-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-primary" id="applySpellingBtn">적용하기</button>
            </div>
        </div>
    </div>
</div>

<!-- Chapter Review Modal -->
<div class="modal fade" id="reviewResultModal" tabindex="-1" aria-labelledby="reviewResultModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reviewResultModalLabel">회차 감평 결과</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="reviewResult"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

<!-- Style Transform Modal -->
<div class="modal fade" id="styleTransformModal" tabindex="-1" aria-labelledby="styleTransformModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="styleTransformModalLabel">문체 변환</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="originalText" class="form-label">원문</label>
                    <textarea class="form-control" id="originalText" rows="4" readonly></textarea>
                </div>
                <div class="mb-3">
                    <label for="transformedText" class="form-label">변환된 문장</label>
                    <div id="transformResult">
                        <div class="d-flex justify-content-center my-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-primary" id="applyTransformBtn">적용하기</button>
            </div>
        </div>
    </div>
</div>

<!-- Modify with Instructions Modal -->
<div class="modal fade" id="modifyWithInstructionsModal" tabindex="-1" aria-labelledby="modifyWithInstructionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modifyWithInstructionsModalLabel">지시에 따라 회차 수정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="instructionsText" class="form-label">지시 사항</label>
                    <textarea class="form-control" id="instructionsText" rows="3" placeholder="예: '주인공의 감정을 더 강조해주세요', '액션 장면을 더 박진감 있게 만들어주세요', '대화를 더 자연스럽게 수정해주세요'"></textarea>
                </div>
                <div class="mb-3">
                    <label for="originalTextInstructions" class="form-label">원문</label>
                    <textarea class="form-control" id="originalTextInstructions" rows="4" readonly></textarea>
                </div>
                <div class="mb-3">
                    <label for="modifiedText" class="form-label">수정된 내용</label>
                    <div id="modifyResult">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle-fill me-2"></i> 지시 사항을 입력하고 '적용하기' 버튼을 클릭하세요.
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-primary" id="applyModifyBtn">적용하기</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const editor = document.getElementById('editor');
        const hiddenContent = document.getElementById('hiddenContent');
        const characterCountElement = document.getElementById('characterCount');
        const wordCountElement = document.getElementById('wordCount');
        const boldBtn = document.getElementById('boldBtn');
        const italicBtn = document.getElementById('italicBtn');
        const underlineBtn = document.getElementById('underlineBtn');
        const checkSpellingBtn = document.getElementById('checkSpellingBtn');
        const reviewChapterBtn = document.getElementById('reviewChapterBtn');
        const assistantModelSelect = document.getElementById('assistantModelSelect');
        const assistantModelInput = document.getElementById('assistantModel');
        const regenerateSummaryBtn = document.getElementById('regenerateSummaryBtn');
        const chapterForm = document.getElementById('chapterForm');
        const spellingResultModal = new bootstrap.Modal(document.getElementById('spellingResultModal'));
        const spellingResult = document.getElementById('spellingResult');
        const applySpellingBtn = document.getElementById('applySpellingBtn');
        const reviewResultModal = new bootstrap.Modal(document.getElementById('reviewResultModal'));
        const reviewResult = document.getElementById('reviewResult');
        const styleTransformModal = new bootstrap.Modal(document.getElementById('styleTransformModal'));
        const originalText = document.getElementById('originalText');
        const transformResult = document.getElementById('transformResult');
        const applyTransformBtn = document.getElementById('applyTransformBtn');
        const elaborateStyleBtn = document.getElementById('elaborateStyleBtn');
        const conciseStyleBtn = document.getElementById('conciseStyleBtn');
        const modifyWithInstructionsBtn = document.getElementById('modifyWithInstructionsBtn');
        const modifyWithInstructionsModal = new bootstrap.Modal(document.getElementById('modifyWithInstructionsModal'));
        const instructionsText = document.getElementById('instructionsText');
        const originalTextInstructions = document.getElementById('originalTextInstructions');
        const modifyResult = document.getElementById('modifyResult');
        const applyModifyBtn = document.getElementById('applyModifyBtn');
        
        // Update word and character count
        function updateCounts() {
            const text = editor.innerText || '';
            const charCount = text.length;
            const wordCount = text.trim() === '' ? 0 : text.trim().split(/\s+/).length;
            
            characterCountElement.textContent = charCount;
            wordCountElement.textContent = wordCount;
        }
        
        // Update hidden textarea with editor content before form submission
        chapterForm.addEventListener('submit', function() {
            hiddenContent.value = editor.innerHTML;
        });
        
        // Initialize counts
        updateCounts();
        
        // Update counts when editor content changes
        editor.addEventListener('input', updateCounts);
        
        // Text formatting buttons
        boldBtn.addEventListener('click', function() {
            document.execCommand('bold', false, null);
            editor.focus();
        });
        
        italicBtn.addEventListener('click', function() {
            document.execCommand('italic', false, null);
            editor.focus();
        });
        
        underlineBtn.addEventListener('click', function() {
            document.execCommand('underline', false, null);
            editor.focus();
        });
        
        // Update assistant model input when select changes
        assistantModelSelect.addEventListener('change', function() {
            assistantModelInput.value = this.value;
        });
        
        // Add regenerate summary flag to form when button is clicked
        regenerateSummaryBtn.addEventListener('click', function() {
            const regenerateInput = document.createElement('input');
            regenerateInput.type = 'hidden';
            regenerateInput.name = 'regenerate_summary';
            regenerateInput.value = 'true';
            chapterForm.appendChild(regenerateInput);
            chapterForm.submit();
        });
        
        // Spelling check
        checkSpellingBtn.addEventListener('click', function() {
            const content = editor.innerHTML;
            const assistantModel = assistantModelSelect.value;
            
            // Show modal with loading spinner
            spellingResult.innerHTML = `
                <div class="d-flex justify-content-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `;
            spellingResultModal.show();
            
            // Send request to check spelling
            fetch('{{ url_for("check_chapter_spelling", novel_id=novel.id, chapter_id=chapter.id) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'content': editor.innerText,
                    'assistant_model': assistantModel
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.result) {
                    if (data.result === '맞춤법 오류 없음') {
                        spellingResult.innerHTML = `
                            <div class="alert alert-success">
                                <i class="bi bi-check-circle-fill me-2"></i> 맞춤법 오류가 없습니다.
                            </div>
                        `;
                        applySpellingBtn.style.display = 'none';
                    } else {
                        spellingResult.innerHTML = `
                            <div class="mb-3">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle-fill me-2"></i> 맞춤법 검사 결과입니다. 적용하려면 '적용하기' 버튼을 클릭하세요.
                                </div>
                                <div class="border p-3 bg-light">
                                    ${data.result.replace(/\n/g, '<br>')}
                                </div>
                            </div>
                        `;
                        applySpellingBtn.style.display = 'block';
                        
                        // Store corrected text
                        applySpellingBtn.dataset.correctedText = data.result;
                    }
                } else {
                    spellingResult.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i> 맞춤법 검사 중 오류가 발생했습니다.
                        </div>
                    `;
                    applySpellingBtn.style.display = 'none';
                }
            })
            .catch(error => {
                spellingResult.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i> 맞춤법 검사 중 오류가 발생했습니다: ${error.message}
                    </div>
                `;
                applySpellingBtn.style.display = 'none';
            });
        });
        
        // Apply spelling corrections
        applySpellingBtn.addEventListener('click', function() {
            const correctedText = this.dataset.correctedText;
            if (correctedText) {
                editor.innerText = correctedText;
                updateCounts();
                spellingResultModal.hide();
            }
        });
        
        // Chapter Review
        reviewChapterBtn.addEventListener('click', function() {
            const content = editor.innerHTML;
            const title = document.getElementById('chapterTitle').value;
            const assistantModel = assistantModelSelect.value;
            
            // Show modal with loading spinner
            reviewResult.innerHTML = `
                <div class="d-flex justify-content-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `;
            reviewResultModal.show();
            
            // Send request to get chapter review
            fetch('{{ url_for("review_chapter_route", novel_id=novel.id, chapter_id=chapter.id) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'content': editor.innerText,
                    'title': title,
                    'assistant_model': assistantModel
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.result) {
                    reviewResult.innerHTML = `
                        <div class="mb-3">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle-fill me-2"></i> 회차 감평 결과입니다.
                            </div>
                            <div class="border p-3 bg-light">
                                ${data.result.replace(/\n/g, '<br>')}
                            </div>
                        </div>
                    `;
                } else {
                    reviewResult.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i> 회차 감평 중 오류가 발생했습니다.
                        </div>
                    `;
                }
            })
            .catch(error => {
                reviewResult.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i> 회차 감평 중 오류가 발생했습니다: ${error.message}
                    </div>
                `;
            });
        });
        
        // Style Transform
        elaborateStyleBtn.addEventListener('click', function() {
            transformStyle('elaborate');
        });
        
        conciseStyleBtn.addEventListener('click', function() {
            transformStyle('concise');
        });
        
        function transformStyle(styleType) {
            // 선택된 텍스트 가져오기
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();
            
            if (!selectedText) {
                alert('변환할 텍스트를 선택해주세요.');
                return;
            }
            
            const assistantModel = assistantModelSelect.value;
            
            // Show modal with loading spinner
            originalText.value = selectedText;
            transformResult.innerHTML = `
                <div class="d-flex justify-content-center my-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `;
            styleTransformModal.show();
            
            // Send request to transform style
            fetch('{{ url_for("transform_style_route", novel_id=novel.id, chapter_id=chapter.id) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'content': selectedText,
                    'assistant_model': assistantModel,
                    'style': styleType
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.result) {
                    transformResult.innerHTML = `
                        <div class="border p-3 bg-light">
                            ${data.result.replace(/\n/g, '<br>')}
                        </div>
                    `;
                    applyTransformBtn.style.display = 'block';
                    
                    // Store transformed text and selection info
                    applyTransformBtn.dataset.transformedText = data.result;
                    applyTransformBtn.dataset.originalText = selectedText;
                    
                    // Store selection range info if possible
                    if (selection.rangeCount > 0) {
                        const range = selection.getRangeAt(0);
                        applyTransformBtn.dataset.selectionStart = getNodeOffset(range.startContainer, range.startOffset);
                        applyTransformBtn.dataset.selectionEnd = getNodeOffset(range.endContainer, range.endOffset);
                    }
                } else {
                    transformResult.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i> 문체 변환 중 오류가 발생했습니다.
                        </div>
                    `;
                    applyTransformBtn.style.display = 'none';
                }
            })
            .catch(error => {
                transformResult.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i> 문체 변환 중 오류가 발생했습니다: ${error.message}
                    </div>
                `;
                applyTransformBtn.style.display = 'none';
            });
        }
        
        // Helper function to get node offset in editor
        function getNodeOffset(node, offset) {
            // This is a simplified approach - in a real implementation
            // you would need more sophisticated logic to handle complex DOM structures
            return { node: node, offset: offset };
        }
        
        // Apply style transform
        applyTransformBtn.addEventListener('click', function() {
            const transformedText = this.dataset.transformedText;
            const originalText = this.dataset.originalText;
            
            if (transformedText && originalText) {
                // 선택된 텍스트를 변환된 텍스트로 대체
                const editorContent = editor.innerHTML;
                editor.innerHTML = editorContent.replace(originalText, transformedText);
                
                updateCounts();
                styleTransformModal.hide();
            }
        });
        
        // Modify with Instructions
        modifyWithInstructionsBtn.addEventListener('click', function() {
            const content = editor.innerText; 
            const assistantModel = assistantModelSelect.value;
            
            // Show modal with loading spinner
            originalTextInstructions.value = content;
            modifyResult.innerHTML = `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle-fill me-2"></i> 지시 사항을 입력하고 '적용하기' 버튼을 클릭하세요.
                </div>
            `;
            modifyWithInstructionsModal.show();
        });
        
        // Apply modify with instructions
        applyModifyBtn.addEventListener('click', function() {
            const modifiedText = this.dataset.modifiedText;
            
            if (modifiedText) {
                // 수정된 텍스트를 에디터에 적용
                editor.innerHTML = modifiedText;
                updateCounts();
                modifyWithInstructionsModal.hide();
                
                // 데이터 초기화
                this.dataset.modifiedText = '';
            } else {
                const instructions = instructionsText.value.trim();
                const originalText = originalTextInstructions.value;
                const assistantModel = assistantModelSelect.value;
                
                if (instructions) {
                    // 로딩 표시
                    modifyResult.innerHTML = `
                        <div class="d-flex justify-content-center my-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    `;
                    
                    // Send request to modify with instructions
                    fetch('{{ url_for("modify_chapter_with_instructions_route", novel_id=novel.id, chapter_id=chapter.id) }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            'content': originalText,
                            'instructions': instructions,
                            'assistant_model': assistantModel
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.result) {
                            modifyResult.innerHTML = `
                                <div class="border p-3 bg-light">
                                    ${data.result.replace(/\n/g, '<br>')}
                                </div>
                            `;
                            
                            // Store modified text
                            applyModifyBtn.dataset.modifiedText = data.result;
                        } else {
                            modifyResult.innerHTML = `
                                <div class="alert alert-danger">
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i> 지시에 따라 수정 중 오류가 발생했습니다.
                                </div>
                            `;
                        }
                    })
                    .catch(error => {
                        modifyResult.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i> 지시에 따라 수정 중 오류가 발생했습니다: ${error.message}
                            </div>
                        `;
                    });
                } else {
                    // 지시 사항이 비어있을 경우 알림
                    alert('지시 사항을 입력해주세요.');
                }
            }
        });
    });
</script>
{% endblock %}
